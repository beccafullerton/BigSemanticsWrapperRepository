<meta_metadata_repository xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  name="googleImageSearch" package="ecologylab.bigsemantics.generated.library.search"
  default_user_agent_name="chrome_2">

  <meta_metadata name="google_image_search" extends="image_search" comment="Google image search."
    parser="xpath" extract_with="service">

    <selector url_regex="https?://www.google.co(m|m?\.\w\w)/search\?.*" domain="google.com">
      <param name="tbm" value="isch" />
    </selector>
    <selector url_regex="https?://www.google.co(m|m?\.\w\w)/webhp\?.*" domain="google.com">
      <param name="tbm" value="isch" />
    </selector>
    <selector url_regex="https?://www.google.co(m|m?\.\w\w)/images\?.*" domain="google.com">
      <param name="tbm" value="isch" />
    </selector>
    <example_url url="https://www.google.com/search?tbm=isch&amp;hl=en&amp;q=watergate" />
    <example_url url="http://www.google.com/search?hl=en&amp;tbm=isch&amp;q=earth" />

    <filter_location>
      <replace pattern="//www.google.co(m|m?\.\w\w)/webhp" to="//www.google.com/search" />
      <override_params />
      <set_param name="btnG" value="search" />
      <set_param name="site" value="imghp" />
      <set_param name="tbm" value="isch" />
      <set_param name="gbv" value="1" />
      <set_param name="hl" value="en" only_when_not_set="true" />
      <strip_params_but>
        <name>q</name>
        <name>tbm</name>
        <name>btnG</name>
        <name>site</name>
        <name>gbv</name>
        <name>hl</name>
      </strip_params_but>
    </filter_location>

    <collection name="search_results">
      <xpath>//div[@id='ires']//td</xpath>
      <scalar name="location" always_show="true">
        <xpath>./a/@href</xpath>
        <location_op extract_param="q" decode_url="true" />
      </scalar>
      <scalar name ="title">
        <xpath>./cite</xpath>
      </scalar>
      <scalar name="thumb_width">
        <xpath>./a/img/@width</xpath>
      </scalar>
      <scalar name="thumb_height">
        <xpath>./a/img/@height</xpath>
      </scalar>
      <scalar name="description">
        <xpath>./b/following-sibling::text()[1]</xpath>
      </scalar>
      <collection name="main_images">
        <xpath>./a</xpath>
        <scalar name="location">
          <xpath>./img/@src</xpath>
          <replace pattern="https://encrypted-tbn([0-9]+)\.google\.com/images" to="http://t$1.gstatic.com/images" />
        </scalar>
      </collection>
    </collection>
    
    <semantic_actions>
      <get_field name="search_results" />
      <for_each collection="search_results" as="result">
        <get_field object="result" name="location" />
        <parse_document>
          <arg name="location" value="location" />
        </parse_document>

        <get_field object="result" name="ref_location" />
        <parse_document>
          <arg name="location" value="ref_location" />
        </parse_document>
      </for_each>
    </semantic_actions>
-
  </meta_metadata>

</meta_metadata_repository>